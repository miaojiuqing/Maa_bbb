name: Sync JSON Schema Files  # 工作流名称

# 触发条件：定时 + 手动
on:
  schedule:
    - cron: '10 0 * * *'  # 每天 UTC 00:10 运行，可修改时间
  workflow_dispatch:  # 允许手动触发

# 权限配置（需写入代码权限）
permissions:
  contents: write

jobs:
  # 检查是否为目标仓库，避免在 fork 或分支误执行
  check-repository:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check repository
        id: check
        run: |
          if [ "${{ github.repository }}" = "miaojiuqing/Maa_bbb" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # 同步 Schema 文件的核心作业
  sync-schema:
    needs: check-repository
    if: ${{ needs.check-repository.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: 拉取当前项目代码
        uses: actions/checkout@v4

      - name: 创建目标目录（若不存在）
        run: |
          mkdir -p deps/tools
          echo "目标目录已准备：deps/tools"

      - name: 从上游下载 Schema 文件
        run: |
          set -e
          # 替换为 MaaFramework 中 Schema 文件的实际 URL
          curl -f -o deps/tools/interface.schema.json https://raw.githubusercontent.com/MaaXYZ/MaaFramework/main/tools/schemas/interface.schema.json
          curl -f -o deps/tools/interface_config.schema.json https://raw.githubusercontent.com/MaaXYZ/MaaFramework/main/tools/schemas/interface_config.schema.json
          curl -f -o deps/tools/pipeline.schema.json https://raw.githubusercontent.com/MaaXYZ/MaaFramework/main/tools/schemas/pipeline.schema.json

          # 检查文件是否下载成功
          ls -l deps/tools/

      - name: 检测文件变更
        id: detect-changes
        run: |
          git config --global --add safe.directory $(pwd)
          git add deps/tools/*.schema.json
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            changed_files=$(git diff --name-only --cached | tr '\n' ' ')
            echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: 提交并推送变更
        if: ${{ steps.detect-changes.outputs.changes_detected == 'true' }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "chore: update schema files - $timestamp\nChanged files: $changed_files"
          git push origin main  # 若主分支不是 main，需修改此处

      - name: 无变更提示
        if: ${{ steps.detect-changes.outputs.changes_detected == 'false' }}
        run: echo "No changes detected in schema files."